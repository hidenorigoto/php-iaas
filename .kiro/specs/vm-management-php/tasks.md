# 実装計画

- [x] 1. プロジェクト基盤セットアップ
  - PHPプロジェクトの基本構造作成（composer.json、autoloading設定）
  - Docker環境の構築（Dockerfile、docker-compose.yml）
  - 開発ツールの設定（PHPUnit、PHPStan、PHP-CS-Fixer）
  - pre-commitフック設定とGit設定
  - 基本的なテストクラスとサンプルコードの作成
  - **完了条件**:
    - `docker-compose up -d` でPHP環境が起動すること
    - `docker-compose exec php-app composer install` が成功すること
    - `docker-compose exec php-app composer test` でテストが実行されること
    - 基本的なPSR-4オートローディングが動作すること
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [x] 2. 基本データクラスとVM管理クラスの実装
  - SimpleVMデータクラスの実装（VM情報とSSH情報を保持）
  - VMManagerクラスの基本構造を作成
  - Monologを使用したログ機能の基本実装
  - 基本的なバリデーション機能の実装
  - **完了条件**: 
    - SimpleVMクラスが正しくインスタンス化され、プロパティが設定できること
    - VMManagerクラスのインスタンス化テストが通ること
    - Monologによるログ出力が正しく動作すること
    - 基本的な入力バリデーション（ユーザー名、VM名等）のテストが通ること
  - _要件: 1.2, 8.1, 8.3_

- [ ] 3. libvirt-php接続機能の実装
  - `libvirt_connect()`を使用した接続機能を実装
  - 接続URI（qemu:///system）の設定
  - 接続エラーハンドリングと権限チェックを追加
  - `libvirt_get_last_error()`を使用したエラー情報取得
  - **完了条件**:
    - `libvirt_connect()`をモック化した`VMManager->connect()`メソッドのユニットテストが通ること
    - モック化された接続成功時にリソースが返されることをテストで確認
    - モック化された接続失敗時に適切なエラーメッセージが返されることをテストで確認
    - `VMManager->isConnected()`メソッドが正しく動作することをモックテストで確認
  - _要件: 4.1, 4.2, 4.3, 5.2_

- [ ] 4. ストレージプールとボリューム管理機能の実装
  - `libvirt_storagepool_lookup_by_name()`でストレージプール取得
  - `libvirt_storagevolume_create_xml()`でディスクボリューム作成
  - qcow2形式のディスクイメージ作成機能を実装
  - ベースイメージからのディスクコピー機能を追加
  - **完了条件**:
    - `libvirt_storagepool_lookup_by_name()`をモック化したストレージプール取得のユニットテストが通ること
    - `libvirt_storagevolume_create_xml()`をモック化したディスクボリューム作成のユニットテストが通ること
    - ファイルシステム操作をモック化し、qcow2ファイル作成ロジックのテストが通ること
    - `VMManager->createDiskVolume()`メソッドが成功時にボリュームパスを返すことをモックテストで確認
  - _要件: 1.2, 1.1_

- [ ] 5. 簡素化されたVLANネットワーク管理機能の実装
  - user1、user2、user3用の独立したlibvirtネットワーク作成
  - 各ユーザーに固定IPレンジ割り当て（192.168.100.x, 192.168.101.x, 192.168.102.x）
  - `libvirt_network_define_xml()`を使用したネットワーク作成
  - ネットワーク分離の実装（NATベース）
  - **完了条件**:
    - `libvirt_network_define_xml()`をモック化したネットワーク作成のユニットテストが通ること
    - 各ユーザー用ネットワーク（vm-network-100, vm-network-101, vm-network-102）のXML生成テストが通ること
    - ネットワーク作成・起動ロジックのモックテストが通ること
    - ユーザー毎のIPレンジ割り当てロジックのテストが通ること
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3_

- [ ] 6. VM設定XML生成機能の実装
  - VM作成用のXML設定テンプレートを作成
  - ストレージボリュームパスとVLANネットワークを含むXML設定生成
  - パラメータに基づくXML設定生成機能を実装
  - デフォルト設定（CPU、メモリ、ディスク、VLAN）の適用
  - **完了条件**:
    - `VMManager->buildVMConfig()`メソッドのユニットテストが通ること
    - 生成されたXMLが有効なlibvirt domain XMLであることをXMLスキーマ検証で確認
    - 各ユーザー（user1、user2、user3）に対して正しいVLAN IDが設定されることをテストで確認
    - デフォルト設定（CPU=2、メモリ=2048MB、ディスク=20GB）が適用されることをテストで確認
  - _要件: 1.2, 1.1, 5.1_

- [ ] 7. VM作成・起動機能の実装
  - `libvirt_domain_define_xml()`を使用したVM定義作成
  - `libvirt_domain_create()`を使用したVM起動機能を実装
  - `libvirt_domain_get_info()`でVM状態確認
  - VM作成・起動の成功/失敗判定を追加
  - **完了条件**:
    - `libvirt_domain_define_xml()`、`libvirt_domain_create()`をモック化した`VMManager->createAndStartVM()`メソッドのユニットテストが通ること
    - モック化された`libvirt_domain_get_info()`でVM状態が'running'になることをテストで確認
    - `exec('virsh list --all')`をモック化し、作成されたVMがリストに表示されることをテストで確認
    - VM作成失敗時に適切なエラーメッセージが返されることをモックテストで確認
  - _要件: 1.1, 1.4_

- [ ] 8. SSH接続情報取得機能の実装
  - `libvirt_domain_get_network_info()`を使用したIPアドレス取得
  - DHCPリース情報からVM IPアドレスを特定
  - SSH認証情報（ユーザー名、パスワード）の生成・管理
  - SSH接続テストによる準備完了確認
  - **完了条件**:
    - `libvirt_domain_get_network_info()`をモック化した`VMManager->getSSHInfo()`メソッドのユニットテストが通ること
    - DHCPリース情報取得をモック化し、IPアドレス取得ロジックのテストが通ること
    - SSH認証情報生成ロジックのユニットテストが通ること
    - `exec('ssh -o ConnectTimeout=5 user@ip echo test')`をモック化し、SSH接続テストロジックのテストが通ること
  - _要件: 1.3, 1.5_

- [ ] 9. エラーハンドリングとログ機能の実装
  - 包括的なエラーハンドリング機能を実装
  - Monologを使用したログ記録機能を追加
  - libvirtエラーの適切な処理とメッセージ変換
  - 入力バリデーションエラーの処理
  - **完了条件**:
    - エラーハンドリングのユニットテストが通ること
    - Monologによるログファイルが正しく作成され、エラー情報が記録されることをテストで確認
    - libvirtエラー発生時に適切なエラーメッセージが返されることをテストで確認
    - 無効なパラメータ入力時にバリデーションエラーが返されることをテストで確認
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ] 10. SlimフレームワークでのWebインターフェース作成
  - Slimルーティングの設定とAPIエンドポイント作成
  - VM作成用のシンプルなHTMLフォームを作成
  - JSON APIとWebフォーム両対応の実装
  - SSH接続情報の表示機能を追加
  - **完了条件**:
    - `GET /`でHTMLフォームが表示されることをHTTPテストで確認
    - `POST /create-vm`でJSON APIが正しく動作することをHTTPテストで確認
    - フォーム送信後にSSH接続情報が表示されることをHTTPテストで確認
    - ユーザー選択（user1、user2、user3）が正しく動作することをHTTPテストで確認
  - _要件: 1.3_

- [ ] 11. 統合テストとデバッグ
  - 完全なVM作成・起動フローのテストを実装
  - エラーケースのテストを追加
  - 実際のlibvirt環境での動作確認
  - **完了条件**:
    - エンドツーエンド統合テストが全て通ること
    - 各ユーザー（user1、user2、user3）でVM作成からSSH接続まで完全に動作することを確認
    - VLAN分離が正しく動作し、異なるVLAN間の通信が禁止されることをネットワークテストで確認
    - 全てのエラーケース（接続失敗、リソース不足、無効パラメータ等）のテストが通ること
    - PHPUnitテストカバレッジが80%以上であることを確認
  - _要件: 1.1, 1.3, 1.4, 1.5_