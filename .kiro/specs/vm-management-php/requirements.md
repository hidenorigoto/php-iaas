# 要件定義書

## 概要

この機能は、libvirtとlibvirt-phpモジュールを活用して、同一環境上で仮想マシン（VM）を作成・起動するミニマムなPHPアプリケーションの開発を含みます。アプリケーションは基本的なVMライフサイクル管理機能を提供し、シンプルなPHPインターフェースを通じてVM作成と起動操作に焦点を当てます。

## 要件

### 要件 1

**ユーザーストーリー:** システム管理者として、PHPアプリケーションを通じて新しい仮想マシンを作成・起動したい。手動介入なしにプログラム的にVMをプロビジョニングし、すぐに使用可能な状態にするため。

#### 受け入れ基準

1. アプリケーションがVM作成リクエストを受信したとき、システムはlibvirt-phpを使用して新しいVMを作成し、同時に起動しなければならない
2. VMを作成するとき、システムは基本的なVM仕様（CPU、メモリ、ディスク）を定義しなければならない
3. VM作成・起動が成功したとき、システムはSSHログイン情報（IPアドレス、ユーザー名、パスワードまたはキー情報）を含むVM詳細を返さなければならない
4. VM作成・起動が失敗した場合、システムは失敗詳細と共にエラーメッセージを返さなければならない
5. 作成されたVMは、システムはSSHアクセス可能な状態で起動しなければならない

### 要件 3

**ユーザーストーリー:** システム管理者として、仮想マシンのステータスを表示したい。VM状態を監視し、操作を確認できるようにするため。

#### 受け入れ基準

1. アプリケーションがVMステータスを照会されたとき、システムは現在のVM状態情報を返さなければならない
2. VMをリストするとき、システムはVM名、状態、基本設定詳細を表示しなければならない
3. 特定のVMを照会するとき、システムはそのVMに関する詳細情報を返さなければならない
4. VMが存在しない場合、システムはVMが利用できないことを示す適切なメッセージを返さなければならない

### 要件 4

**ユーザーストーリー:** 開発者として、PHPアプリケーションがlibvirt接続管理を処理することを望む。VM操作が確実に実行されるようにするため。

#### 受け入れ基準

1. アプリケーションが開始されたとき、システムはローカルlibvirtデーモンへの接続を確立しなければならない
2. VM操作を実行するとき、システムは確立されたlibvirt接続を使用しなければならない
3. 接続が失敗したとき、システムは接続問題を示すエラーメッセージを返さなければならない
4. 操作が完了したとき、システムはlibvirt接続を適切に閉じなければならない

### 要件 5

**ユーザーストーリー:** システム管理者として、OpenVSwitchを使用したVLAN管理機能により、適切なネットワーク分離を実現したい。管理ホストからのアクセスを可能にしつつ、VLAN間の通信を制御するため。

#### 受け入れ基準

1. VMネットワークを初めて作成する際、システムはOpenVSwitch VMを自動作成しなければならない
2. OpenVSwitchによりVLAN管理機能を提供し、VLAN間通信制御を実現しなければならない
3. 管理ホストなど外部からはIPアドレスでVMへのアクセスが可能でなければならない
4. 同一VLAN内のVM同士のアクセスは許可されなければならない
5. 異なるVLAN間のVM同士のアクセスは禁止されなければならない

### 要件 6

**ユーザーストーリー:** システム管理者として、VM作成時にユーザー（user1、user2、user3）を選択し、各ユーザーに固定のVLAN IDが割り当てられることを望む。ユーザー毎のネットワーク分離を確保するため。

#### 受け入れ基準

1. VM作成時、システムはuser1、user2、user3から選択可能なユーザー選択機能を提供しなければならない
2. user1はVLAN ID 100、user2はVLAN ID 101、user3はVLAN ID 102に固定で割り当てられなければならない
3. 選択されたユーザーに基づいて、VMは対応するVLANネットワークに自動配置されなければならない
4. VM上からVLAN IDを変更できないように設定しなければならない
5. VLAN設定はlibvirtレベルで管理され、VM内部からは変更不可能でなければならない

### 要件 7

**ユーザーストーリー:** 開発者として、GitHub連携による効率的な開発ワークフローを実現したい。コード品質を保ちながら、タスク管理とコード管理を統合するため。

#### 受け入れ基準

1. 各実装タスクに対してGitHub Issueを作成し、進捗管理を行わなければならない
2. 各タスクの実装はfeatureブランチで行い、プルリクエストによるコードレビューを実施しなければならない
3. コミット時にpre-commitフックによる自動チェック（PHPStan、PHP-CS-Fixer、PHPUnit）を実行しなければならない
4. プルリクエストマージ時にGitHub ActionsによるCI/CDパイプラインを実行しなければならない
5. コミットメッセージはConventional Commits形式に従わなければならない

### 要件 8

**ユーザーストーリー:** システム管理者として、基本的なエラーハンドリングとログ機能を望む。VM操作が失敗したときに問題をトラブルシューティングできるようにするため。

#### 受け入れ基準

1. VM操作が失敗したとき、システムはタイムスタンプと詳細と共にエラーをログに記録しなければならない
2. libvirtエラーが発生したとき、システムは意味のあるエラーメッセージをキャプチャして表示しなければならない
3. 無効なパラメータが提供されたとき、システムは入力を検証し、適切なエラーメッセージを返さなければならない
4. システムリソースが不十分なとき、システムはリソース関連のエラーメッセージを返さなければならない